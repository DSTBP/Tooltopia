<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Flight Out - 图片旋转版</title>
    <link rel="icon" href="favicon.png">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
    /* 本页样式：为每个格子放置图片切片，并显示提示数字 */
    .fo-board { --cell: 56px; }
    .pic-form .fo-row { gap: 16px; align-items: center; }
    .pic-form .inline { display: flex; align-items: center; gap: 8px; }
    .pic-form .inline input[type="number"]{ width: 84px; }
    .pic-form .url-input { width: 340px; padding: 6px 10px; border-radius: 8px; border: 1px solid #dee2e6; }
    .pic-form .group { display: flex; gap: 18px; align-items: center; }
    .pic-form .group .left { display: flex; flex-direction: column; gap: 10px; }
    .pic-form .hint { color: #667085; font-size: 12px; }
    .fo-cell.pic {
        position: relative;
        overflow: hidden;
        background: transparent !important;
    }
    .fo-cell.pic .piece {
        position: absolute;
        left: 0; top: 0; right: 0; bottom: 0;
        background-repeat: no-repeat;
        background-size: var(--bgW) var(--bgH);
        transform-origin: center center;
        transition: transform 120ms ease-out;
    }
    .fo-cell.pic.hint-num {
        color: var(--hintColor, #1f2d3d);
        font-weight: 700;
        font-size: 0.95rem;
        text-shadow: 0 1px 0 rgba(255,255,255,0.6);
    }
    .fo-cell.pic .hintText {
        position: absolute;
        left: 0; right: 0; top: 0; bottom: 0;
        display: flex; align-items: center; justify-content: center;
        pointer-events: none;
        background: var(--hintBg, transparent);
        border-radius: 6px;
        font-size: 1.2rem;
        font-weight: 800;
        line-height: 1;
    }
    .fo-preview {
        width: 120px; height: 120px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        background-size: cover; background-position: center;
    }
    
    /* 语言选择器统一样式 - 使用更强的选择器 */
    #translate,
    #translate .translate_selectLanguage_tag,
    .translate_selectLanguage_tag,
    div[id="translate"],
    div[id="translate"] .translate_selectLanguage_tag {
        position: fixed !important;
        top: 20px !important;
        right: 20px !important;
        z-index: 9999 !important;
        background: rgba(255, 255, 255, 0.15) !important;
        color: white !important;
        padding: 0 !important;
        border-radius: 20px !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        backdrop-filter: blur(10px) !important;
        cursor: pointer !important;
        font-size: 0.9rem !important;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        transition: all 0.3s ease !important;
        display: inline-block !important;
        margin: 0 !important;
        min-width: 120px !important;
        height: 36px !important;
        overflow: visible !important;
    }
    
    #translate:hover,
    #translate .translate_selectLanguage_tag:hover,
    .translate_selectLanguage_tag:hover,
    div[id="translate"]:hover,
    div[id="translate"] .translate_selectLanguage_tag:hover {
        background: rgba(255, 255, 255, 0.25) !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2) !important;
    }
    
    #translate select,
    #translate .translate_selectLanguage_tag select,
    .translate_selectLanguage_tag select,
    div[id="translate"] select,
    div[id="translate"] .translate_selectLanguage_tag select {
        background: transparent !important;
        border: none !important;
        color: white !important;
        font-size: 0.9rem !important;
        font-family: inherit !important;
        cursor: pointer !important;
        outline: none !important;
        appearance: none !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        width: 100% !important;
        height: 100% !important;
        padding: 8px 16px !important;
        margin: 0 !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        opacity: 1 !important;
    }
    
    #translate select option,
    #translate .translate_selectLanguage_tag select option,
    .translate_selectLanguage_tag select option,
    div[id="translate"] select option,
    div[id="translate"] .translate_selectLanguage_tag select option {
        background: white !important;
        color: #333 !important;
    }
    
    /* 移动端适配 */
    @media (max-width: 768px) {
        #translate,
        #translate .translate_selectLanguage_tag,
        .translate_selectLanguage_tag,
        div[id="translate"],
        div[id="translate"] .translate_selectLanguage_tag {
            top: 10px !important;
            right: 10px !important;
            min-width: 100px !important;
            height: 32px !important;
            font-size: 0.8rem !important;
        }
        
        #translate select,
        #translate .translate_selectLanguage_tag select,
        .translate_selectLanguage_tag select,
        div[id="translate"] select,
        div[id="translate"] .translate_selectLanguage_tag select {
            padding: 6px 12px !important;
            font-size: 0.8rem !important;
        }
    }
    </style>
    <script src="assets/js/solve-colorful.js"></script>
    <script>
    // 通过背景定位切片：背景整体尺寸按 (cols*100%) x (rows*100%)，每片位置为 (c/cols*100%, r/rows*100%)
    </script>
</head>
<body>
    <div class="fo-container">
        <header class="fo-header">
            <h1>Flight Out - 图片旋转版</h1>
            <p class="fo-sub">点击某格会使“自身+上下左右”顺时针旋转 90°。共 4 种状态，旋转 4 次回到初始。</p>
        </header>

        <section class="fo-panel">
            <div class="fo-left">
                <div class="fo-controls pic-form">
                    <div class="fo-row">
                        <label class="inline">行 <input type="number" id="rowsInput" min="2" max="20" value="3"></label>
                        <label class="inline">列 <input type="number" id="colsInput" min="2" max="20" value="3"></label>
                    </div>
                    <div class="fo-row group">
                        <div class="left">
                            <label class="inline">本地图片 <input type="file" id="fileInput" accept="image/*"></label>
                            <label class="inline">图片链接
                                <input type="text" id="photoUrl" class="url-input" placeholder="https://...">
                            </label>
                            <div class="hint">支持本地文件或网络链接，加载后自动匹配高对比提示色</div>
                        </div>
                        <div class="fo-preview" id="preview"></div>
                    </div>
                    <div class="fo-row">
                        <button id="loadPhoto" class="fo-btn">加载图片</button>
                        <button id="reset" class="fo-btn">重开本关</button>
                        <button id="undo" class="fo-btn" disabled>撤销</button>
                        <button id="shuffle" class="fo-btn">随机一图</button>
                        <button id="hint" class="fo-btn">提示</button>
                        <a href="variant.html" class="fo-btn" id="variantBtn" style="margin-left: 8px;">返回中心</a>
                    </div>
                    <div class="fo-stats">
                        <span>步数：<b id="moveCount">0</b></span>
                        <span id="minStepsWrap" style="display:none;">最少需要 <b id="minSteps">-</b> 步</span>
                        <span id="statusText"></span>
                    </div>
                </div>

                <div class="fo-help">
                    <details open>
                        <summary>如何游玩 / 规则说明</summary>
                        <ul>
                            <li>将图片切割为 m x n 的网格，每一块为一个格子。</li>
                            <li>点击会使“自身+上下左右”顺时针旋转 90°。</li>
                            <li>目标：所有格子回到初始方向（旋转 0 度）。</li>
                            <li>支持从本地、链接以及随机一图选择图片。</li>
                            <li>支持自定义盘面尺寸，最大不超过 20 行 20 列。</li>
                            <li>“提示”使用 4 状态求解器计算，按数字显示剩余次数。</li>
                            <li>网络图片链接、随机一图加载需要较长时间，请耐心等待。</li>
                        </ul>
                    </details>
                </div>
            </div>

            <div class="fo-board-wrap">
                <div id="board" class="fo-board" aria-label="pic-grid" role="grid"></div>
            </div>
        </section>
    </div>

    <script>
    (function(){
        const boardEl = document.getElementById('board');
        const rowsInput = document.getElementById('rowsInput');
        const colsInput = document.getElementById('colsInput');
        const fileInput = document.getElementById('fileInput');
        const photoUrlInput = document.getElementById('photoUrl');
        const loadPhotoBtn = document.getElementById('loadPhoto');
        const previewEl = document.getElementById('preview');
        const resetBtn = document.getElementById('reset');
        const undoBtn = document.getElementById('undo');
        const hintBtn = document.getElementById('hint');
        const moveCountEl = document.getElementById('moveCount');
        const statusText = document.getElementById('statusText');
        const minStepsEl = document.getElementById('minSteps');
        const minStepsWrap = document.getElementById('minStepsWrap');

        const K = 4; // 四状态
        let rows = 3, cols = 3;
        let grid = createMatrix(rows, cols, 0);
        let moveCount = 0;
        let undoStack = [];
        let hintMode = false; // 是否显示提示
        let hintCounts = new Map(); // key -> remain
        let imgUrl = '';
        let naturalW = 0, naturalH = 0;
        let hintTextColor = '#1f2d3d';
        let hintBgColor = 'rgba(255,255,255,0.0)';

        init();

        function init(){
            boardEl.addEventListener('click', onBoardClick);
            rowsInput.addEventListener('input', onSizeChange);
            colsInput.addEventListener('input', onSizeChange);
            if (fileInput) fileInput.addEventListener('change', onFileSelect);
            resetBtn.addEventListener('click', resetLevel);
            undoBtn.addEventListener('click', undoMove);
            document.getElementById('shuffle').addEventListener('click', loadRandomImage);
            hintBtn.addEventListener('click', toggleHint);
            if (loadPhotoBtn) loadPhotoBtn.addEventListener('click', loadSelectedPhoto);
            renderBoard();
        }

        function loadSelectedPhoto(){
            if (!photoUrlInput) return;
            const url = (photoUrlInput.value||'').trim();
            if (!url) {
                alert('请输入图片链接');
                return;
            }
            
            // 使用 AllOrigins 代理处理用户输入的图片链接
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
            console.log(`用户输入图片链接，使用 AllOrigins 代理: ${proxyUrl}`);
            
            fetch(proxyUrl)
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return res.blob();   // 获取图片二进制数据
                })
                .then(blob => {
                    const blobUrl = URL.createObjectURL(blob);
                    console.log(`用户图片链接代理成功，blob 地址: ${blobUrl}`);
                    setImageUrl(blobUrl, false, 0);
                })
                .catch(err => {
                    console.error('用户图片链接代理失败:', err);
                    // 如果代理失败，尝试直接使用原始URL
                    console.log('尝试直接使用原始URL:', url);
                    setImageUrl(url, false, 0);
                });
        }

        function onFileSelect(e){
            const file = e.target.files && e.target.files[0];
            if (!file) {
                alert('请选择图片文件');
                return;
            }
            
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件');
                return;
            }
            
            // 清除之前的URL（如果存在）
            if (imgUrl && imgUrl.startsWith('blob:')) {
                URL.revokeObjectURL(imgUrl);
            }
            
            const url = URL.createObjectURL(file);
            setImageUrl(url, false, 0);
            
            // 重置文件输入框，确保下次选择相同文件时也能触发change事件
            e.target.value = '';
        }

        function setImageUrl(url, isFromRandomImage = false, currentIndex = 0) {
            if (!url) return;
            
            // 更新全局图片URL，更新预览区背景（先显示占位，提升体验）
            imgUrl = url;
            previewEl.style.backgroundImage = `url('${imgUrl}')`;
            // 可选：添加加载中样式（如模糊过渡）
            previewEl.style.opacity = '0.5';
            
            // 创建Image对象验证加载状态（避免直接用backgroundImage无法捕获错误）
            const img = new Image();
            // 关键：启用跨域支持（部分API需要）
            img.crossOrigin = 'anonymous';

            // 图片加载成功回调
            img.onload = () => {
                // 恢复预览区透明度，标记真实图片尺寸
                previewEl.style.opacity = '1';
                naturalW = img.naturalWidth;
                naturalH = img.naturalHeight;
                // 执行图片颜色分析（原逻辑保留）
                analyzeImageForHintColor(img);
                console.log(`第 ${currentIndex + 1} 个图源加载成功: ${imgUrl}`);
                // 图片加载成功后执行随机打乱（原逻辑保留）
                shuffleRandom();
            };
            
            // 图片加载失败回调
            img.onerror = (error) => {
                console.error(`第 ${currentIndex + 1} 个图源加载失败:`, error);
                // 清空无效URL和预览区背景
                imgUrl = '';
                previewEl.style.backgroundImage = 'none';
                previewEl.style.opacity = '1';
                
                // 如果是随机图片加载失败，自动尝试下一个图源
                if (isFromRandomImage) {
                    tryNextRandomImage(currentIndex + 1);
                } else {
                    // 手动输入链接失败，提示用户检查
                    alert('手动输入的图片链接加载失败，请确认链接有效且支持跨域访问~');
                }
            };
            
            // 触发图片加载（必须放在最后，确保onload/onerror已绑定）
            img.src = imgUrl;
        }

        function onSizeChange(){
            rows = clamp(parseInt(rowsInput.value||'3',10)||3, 2, 20);
            cols = clamp(parseInt(colsInput.value||'3',10)||3, 2, 20);
            grid = createMatrix(rows, cols, 0);
            moveCount = 0; undoStack = [];
            exitHintMode();
            renderBoard();
        }

        function resetLevel(){
            grid = createMatrix(rows, cols, 0);
            moveCount = 0; undoStack = [];
            exitHintMode();
            renderBoard();
        }

        // 全局变量存储图源列表（使用多个CORS代理服务）
        // ------------------- 图源列表 -------------------
        let imageSources = [
            // 必应每日一图（通过 AllOrigins 代理 JSON）
            () => `https://api.allorigins.win/raw?url=${encodeURIComponent(
                `https://cn.bing.com/HPImageArchive.aspx?format=js&idx=${Math.floor(Math.random() * 30)}&n=1&mkt=zh-CN`
            )}`,

            // 随机二次元（通过 AllOrigins 代理）
            () => `https://api.allorigins.win/raw?url=${encodeURIComponent('https://t.alcy.cc/fj')}`,
            () => `https://api.allorigins.win/raw?url=${encodeURIComponent('http://www.98qy.com/sjbz/api.php')}`,
            () => `https://api.allorigins.win/raw?url=${encodeURIComponent('https://imgapi.xl0408.top/index.php')}`,
            () => `https://api.allorigins.win/raw?url=${encodeURIComponent('https://www.dmoe.cc/random.php')}`,
            () => `https://api.allorigins.win/raw?url=${encodeURIComponent('https://api.mtyqx.cn/tapi/random.php')}`,
            () => `https://api.allorigins.win/raw?url=${encodeURIComponent('https://cdn.seovx.com/?mom=302')}`,

            // 无需 CORS 的公开随机图
            () => `https://picsum.photos/800/600?random=${Date.now()}`,
            () => `https://source.unsplash.com/800x600/?nature&${Date.now()}`,
            () => `https://placekitten.com/800/600?random=${Date.now()}`,
            () => `https://picsum.photos/800/600?blur=1&random=${Date.now()}`
        ];

        // ------------------- 尝试加载随机图片 -------------------
        function tryNextRandomImage(index) {
            if (index >= imageSources.length) {
                alert('所有图源已尝试，当前暂无可用图片，请稍后重试~');
                return;
            }

            const sourceFunction = imageSources[index];
            const sourceUrl = sourceFunction();
            console.log(`正在尝试第 ${index + 1} 个图源: ${sourceUrl}`);

            // 如果是必应 API（第 1 个图源）
            if (index === 0) {
                fetch(sourceUrl)
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                        return res.json();
                    })
                    .then(data => {
                        if (data.images && data.images[0] && data.images[0].url) {
                            const imageUrl = 'https://cn.bing.com' + data.images[0].url;
                            console.log(`必应API成功: ${imageUrl}`);
                            setImageUrl(imageUrl, true, index);
                        } else {
                            throw new Error('必应API返回格式错误');
                        }
                    })
                    .catch(err => {
                        console.error('必应API失败:', err);
                        tryNextRandomImage(index + 1);
                    });
            }
            // 如果是 AllOrigins 代理的图源
            else if (sourceUrl.includes('allorigins.win')) {
                fetch(sourceUrl)
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                        return res.blob();   // 拿到图片二进制
                    })
                    .then(blob => {
                        const blobUrl = URL.createObjectURL(blob);
                        console.log(`AllOrigins 成功，blob 地址: ${blobUrl}`);
                        setImageUrl(blobUrl, true, index);
                    })
                    .catch(err => {
                        console.error(`AllOrigins 失败:`, err);
                        tryNextRandomImage(index + 1);
                    });
            }
            // 普通图源（无需 CORS）
            else {
                setImageUrl(sourceUrl, true, index);
            }
        }

        function loadRandomImage() {
            // 可选：加载前清空预览区，避免旧图残留
            previewEl.style.backgroundImage = 'none';
            // 从第一个图源开始尝试
            tryNextRandomImage(0);
        }

        function shuffleRandom(){
            // 对每个单元以一定概率随机旋转 0..3 次，确保非全 0
            const prev = createMatrix(rows, cols, 0);
            grid = createMatrix(rows, cols, 0);
            let changed = false;
            for (let r=0;r<rows;r++) for (let c=0;c<cols;c++){
                const t = Math.floor(Math.random()*4); if(t>0){ grid[r][c]=t; changed=true; }
            }
            if (!changed) grid[0][0] = 1;
            moveCount = 0; undoStack = [];
            exitHintMode();
            renderBoard();
            animatePiecesFromTo(prev, grid);
        }

        function createMatrix(r,c,fill=0){
            return Array.from({length:r},()=>Array.from({length:c},()=>fill));
        }

        function renderBoard(){
            boardEl.innerHTML = '';
            boardEl.style.setProperty('--rows', String(rows));
            boardEl.style.setProperty('--cols', String(cols));
            // 设置整体背景尺寸百分比
            const bgW = `${cols*100}%`;
            const bgH = `${rows*100}%`;
            boardEl.style.setProperty('--bgW', bgW);
            boardEl.style.setProperty('--bgH', bgH);
            if (boardEl && hintTextColor) {
                boardEl.style.setProperty('--hintColor', hintTextColor);
                boardEl.style.setProperty('--hintBg', hintBgColor);
            }

            for (let r=0; r<rows; r++){
                for (let c=0; c<cols; c++){
                    const cell = document.createElement('button');
                    cell.className = 'fo-cell pic';
                    cell.setAttribute('data-r', String(r));
                    cell.setAttribute('data-c', String(c));

                    const piece = document.createElement('div');
                    piece.className = 'piece';
                    if (imgUrl) piece.style.backgroundImage = `url('${imgUrl}')`;
                    const bx = (c/(cols-1||1))*100; // 百分比位置
                    const by = (r/(rows-1||1))*100;
                    piece.style.backgroundPosition = `${bx}% ${by}%`;
                    piece.style.transform = `rotate(${(grid[r][c]%K)*90}deg)`;
                    cell.appendChild(piece);

                    if (hintMode && hintCounts.has(r+','+c)){
                        cell.classList.add('hint-num');
                        const txt = document.createElement('div');
                        txt.className = 'hintText';
                        txt.textContent = String(hintCounts.get(r+','+c));
                        cell.appendChild(txt);
                    }

                    boardEl.appendChild(cell);
                }
            }
            moveCountEl.textContent = String(moveCount);
            undoBtn.disabled = undoStack.length===0;
            statusText.textContent = '';
        }

        function onBoardClick(e){
            const target = e.target;
            if(!(target instanceof HTMLElement)) return;
            const cell = target.closest('.fo-cell');
            if(!cell) return;
            const r = parseInt(cell.getAttribute('data-r'),10);
            const c = parseInt(cell.getAttribute('data-c'),10);

            const before = deepClone(grid);
            applyFlip(r,c,true);

            if (hintMode){
                // 确认真实点击（仅这五个格子变化）
                const deltas=[[0,0],[1,0],[-1,0],[0,1],[0,-1]];
                const changed=new Set();
                for(let i=0;i<rows;i++) for(let j=0;j<cols;j++) if((before[i][j]%K)!==(grid[i][j]%K)) changed.add(i+','+j);
                const expected=new Set();
                for(const [dr,dc] of deltas){ const rr=r+dr, cc=c+dc; if(inBounds(rr,cc)) expected.add(rr+','+cc); }
                let isDirect=true; for(const key of expected){ if(!changed.has(key)){ isDirect=false; break; } }
                if (isDirect && changed.size!==expected.size) isDirect=false;
                if (isDirect){
                    const k=r+','+c;
                    if(hintCounts.has(k)){
                        let v=hintCounts.get(k)-1; if(v<=0) hintCounts.delete(k); else hintCounts.set(k,v);
                    }
                }
                // 仍需展示旋转动画后的状态
                renderBoard();
                animatePiecesFromTo(before, grid);
            }
        }

        function applyFlip(r,c,record){
            if(!inBounds(r,c)) return;
            const prevGrid = deepClone(grid);
            const snapshot = deepClone(grid);
            const deltas=[[0,0],[1,0],[-1,0],[0,1],[0,-1]];
            for(const [dr,dc] of deltas){ const rr=r+dr, cc=c+dc; if(inBounds(rr,cc)) grid[rr][cc]=(grid[rr][cc]+1)%K; }
            moveCount++;
            if(record) undoStack.push(snapshot);
            renderBoard();
            animatePiecesFromTo(prevGrid, grid);
            if (isAllTarget()) showSuccessModal();
        }

        function isAllTarget(){
            for(let i=0;i<rows;i++) for(let j=0;j<cols;j++) if((grid[i][j]%K)!==0) return false; return true;
        }

        function inBounds(r,c){ return r>=0 && r<rows && c>=0 && c<cols; }
        function deepClone(m){ return m.map(row=>row.slice()); }
        function animatePiecesFromTo(prev, next){
            try {
                for (let r=0;r<rows;r++){
                    for (let c=0;c<cols;c++){
                        const piece = boardEl.querySelector(`.fo-cell[data-r="${r}"][data-c="${c}"] .piece`);
                        if (!piece) continue;
                        const fromDeg = ((prev[r][c]%K)+K)%K * 90;
                        const rawTo = ((next[r][c]%K)+K)%K * 90;
                        // 始终顺时针：将目标角度调整为 fromDeg 向前（+）到达 rawTo
                        const delta = (rawTo - fromDeg + 360) % 360; // 0..270
                        const toDeg = fromDeg + delta; // 单调递增

                        // 先无动画设置到起点
                        const oldTransition = piece.style.transition;
                        piece.style.transition = 'none';
                        piece.style.transform = `rotate(${fromDeg}deg)`;
                        // 强制回流
                        void piece.offsetWidth;
                        // 再恢复动画并设置到目标
                        piece.style.transition = oldTransition || 'transform 180ms ease-out';
                        requestAnimationFrame(()=>{ piece.style.transform = `rotate(${toDeg}deg)`; });
                    }
                }
            } catch(_) {}
        }

        function analyzeImageForHintColor(image){
            try {
                const w = 80, h = 80; // 取缩略图近似平均亮度
                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(image, 0, 0, w, h);
                const data = ctx.getImageData(0,0,w,h).data;
                let sum = 0; const n = w*h;
                for (let i=0;i<data.length;i+=4){
                    const r=data[i], g=data[i+1], b=data[i+2];
                    const lum = 0.2126*r + 0.7152*g + 0.0722*b; // 相对亮度
                    sum += lum;
                }
                const avg = sum / n; // 0..255
                // 亮图用深色字+浅底，暗图用浅色字+深底
                if (avg >= 140) {
                    hintTextColor = '#1f2d3d';
                    hintBgColor = 'rgba(255,255,255,0.35)';
                } else {
                    hintTextColor = '#f8f9fa';
                    hintBgColor = 'rgba(0,0,0,0.35)';
                }
            } catch (_) {
                hintTextColor = '#1f2d3d';
                hintBgColor = 'rgba(255,255,255,0.25)';
            }
        }

        function undoMove(){ if(undoStack.length===0) return; grid=undoStack.pop(); moveCount=Math.max(0,moveCount-1); renderBoard(); }

        function toggleHint(){ if(hintMode) exitHintMode(); else enterHintMode(); }

        function enterHintMode(){
            try {
                const solver = new NStateMatrixSolver(grid.map(row=>row.map(v=>v%K)), K);
                const res = solver.solve();
                if (!solver.hasSolution){
                    hintCounts = new Map();
                    if (minStepsWrap) { minStepsWrap.textContent='此初始状态无解'; minStepsWrap.style.display=''; }
                    hintMode = true; if(hintBtn) hintBtn.textContent='隐藏提示'; renderBoard(); return;
                }
                const plan = solver.fullPlan || [];
                hintCounts = new Map();
                for(let r=0;r<plan.length;r++) for(let c=0;c<plan[0].length;c++){
                    const need = plan[r][c]%K; if(need) hintCounts.set(r+','+c, need);
                }
                if (minStepsWrap){
                    let min=0; for(const row of plan) for(const v of row) min += (v%K);
                    minStepsWrap.innerHTML = '最少需要 <b id="minSteps"></b> 步';
                    const el = document.getElementById('minSteps'); if(el) el.textContent=String(min);
                    minStepsWrap.style.display='';
                }
                hintMode = true; if(hintBtn) hintBtn.textContent='隐藏提示'; renderBoard();
            } catch(err){ statusText.textContent='提示计算失败或无解'; }
        }

        function exitHintMode(){
            hintMode = false;
            hintCounts = new Map();
            if (hintBtn) hintBtn.textContent = '提示';
            if (minStepsWrap) minStepsWrap.style.display = 'none';
            renderBoard();
        }

        function showSuccessModal(){
            const modal = document.createElement('div'); modal.className='success-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>完成拼图</h3>
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" id="closeModal">关闭</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            const cleanup=()=>{ if(modal&&modal.parentNode) modal.parentNode.removeChild(modal); };
            modal.addEventListener('click',(e)=>{ if(e.target===modal) cleanup(); });
            modal.querySelector('#closeModal').addEventListener('click', cleanup);
        }

        function clamp(v,lo,hi){ return Math.max(lo, Math.min(hi,v)); }
    })();
    </script>

    <!-- translate.js 多语言翻译功能 -->
    <script src="assets/js/translate.js"></script>
    <script>
        // 设置翻译服务
        translate.service.use('client.edge')
        // 设置默认翻译目标语种为中文简体
        translate.language.setDefaultTo('chinese_simplified')
        // 设置本地语种为中文简体
        translate.language.setLocal('chinese_simplified')
        // 开启页面变化监控，对变化部分进行自动翻译
        translate.listener.start()
        // 显示语言选择器
        translate.selectLanguageTag.show = true
        // 自动识别用户语言
        translate.setAutoDiscriminateLocalLanguage()
        // 跳过不需要翻译的元素
        translate.ignore.class.push('no-translate')
        
        // 强制应用样式的函数
        function forceLanguageSelectorStyle() {
            // 查找所有可能的语言选择器元素
            const selectors = [
                '#translate',
                '.translate_selectLanguage_tag',
                '[id="translate"]',
                'div[id="translate"]'
            ]
            
            selectors.forEach(selector => {
                const elements = document.querySelectorAll(selector)
                elements.forEach(element => {
                    if (element) {
                        // 强制设置样式
                        element.style.setProperty('position', 'fixed', 'important')
                        element.style.setProperty('top', '20px', 'important')
                        element.style.setProperty('right', '20px', 'important')
                        element.style.setProperty('z-index', '9999', 'important')
                        element.style.setProperty('background', 'rgba(255, 255, 255, 0.15)', 'important')
                        element.style.setProperty('color', 'white', 'important')
                        element.style.setProperty('padding', '0', 'important')
                        element.style.setProperty('border-radius', '20px', 'important')
                        element.style.setProperty('border', '1px solid rgba(255, 255, 255, 0.3)', 'important')
                        element.style.setProperty('backdrop-filter', 'blur(10px)', 'important')
                        element.style.setProperty('cursor', 'pointer', 'important')
                        element.style.setProperty('font-size', '0.9rem', 'important')
                        element.style.setProperty('font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif", 'important')
                        element.style.setProperty('box-shadow', '0 4px 12px rgba(0, 0, 0, 0.15)', 'important')
                        element.style.setProperty('transition', 'all 0.3s ease', 'important')
                        element.style.setProperty('display', 'inline-block', 'important')
                        element.style.setProperty('margin', '0', 'important')
                        element.style.setProperty('min-width', '120px', 'important')
                        element.style.setProperty('height', '36px', 'important')
                        element.style.setProperty('overflow', 'visible', 'important')
                        
                        // 为select元素设置样式
                        const selectElement = element.querySelector('select')
                        if (selectElement) {
                            selectElement.style.setProperty('background', 'transparent', 'important')
                            selectElement.style.setProperty('border', 'none', 'important')
                            selectElement.style.setProperty('color', 'white', 'important')
                            selectElement.style.setProperty('font-size', '0.9rem', 'important')
                            selectElement.style.setProperty('cursor', 'pointer', 'important')
                            selectElement.style.setProperty('outline', 'none', 'important')
                            selectElement.style.setProperty('width', '100%', 'important')
                            selectElement.style.setProperty('height', '100%', 'important')
                            selectElement.style.setProperty('padding', '8px 16px', 'important')
                            selectElement.style.setProperty('margin', '0', 'important')
                            selectElement.style.setProperty('position', 'absolute', 'important')
                            selectElement.style.setProperty('top', '0', 'important')
                            selectElement.style.setProperty('left', '0', 'important')
                            selectElement.style.setProperty('opacity', '1', 'important')
                            selectElement.style.setProperty('appearance', 'none', 'important')
                            selectElement.style.setProperty('-webkit-appearance', 'none', 'important')
                            selectElement.style.setProperty('-moz-appearance', 'none', 'important')
                            
                            // 为select的option元素设置样式
                            const options = selectElement.querySelectorAll('option')
                            options.forEach(option => {
                                option.style.setProperty('background', 'white', 'important')
                                option.style.setProperty('color', '#333', 'important')
                            })
                        }
                    }
                })
            })
        }
        
        // 页面加载完成后执行翻译
        document.addEventListener('DOMContentLoaded', function() {
            translate.execute()
            
            // 延迟执行以确保DOM完全加载
            setTimeout(function() {
                translate.execute()
                forceLanguageSelectorStyle()
            }, 500)
            
            // 多次检查确保样式生效
            setTimeout(function() {
                forceLanguageSelectorStyle()
            }, 1000)
            
            setTimeout(function() {
                forceLanguageSelectorStyle()
            }, 2000)
            
            // 定期检查语言选择器样式
            setInterval(forceLanguageSelectorStyle, 3000)
            
            // 监听DOM变化，当新元素添加时应用样式
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        setTimeout(forceLanguageSelectorStyle, 100)
                    }
                })
            })
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            })
        })
    </script>
</body>
</html>